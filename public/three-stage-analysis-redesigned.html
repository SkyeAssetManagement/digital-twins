<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Twins Analysis Lab</title>
    <style>
        :root {
            /* Color System */
            --primary: #6366f1;
            --primary-light: #a5b4fc;
            --primary-dark: #4338ca;
            
            --success: #10b981;
            --success-light: #6ee7b7;
            --success-bg: #d1fae5;
            
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --warning-bg: #fef3c7;
            
            --danger: #ef4444;
            --danger-light: #f87171;
            --danger-bg: #fee2e2;
            
            --info: #3b82f6;
            --info-light: #93c5fd;
            --info-bg: #dbeafe;
            
            /* Neutral Palette */
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
            
            /* Background System - Professional Dark Theme */
            --bg-primary: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --bg-card: rgba(45, 55, 72, 0.95);
            --bg-glass: rgba(255, 255, 255, 0.08);
            --bg-overlay: rgba(26, 32, 44, 0.9);
            
            /* Shadows - Enhanced for Dark Theme */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            
            /* Animation */
            --transition: all 0.2s ease-in-out;
            --bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--neutral-800);
            overflow-x: hidden;
        }

        /* Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header with Floating Effect */
        .header {
            text-align: center;
            color: #f7fafc;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
            background: linear-gradient(135deg, #f7fafc 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(0.5deg); }
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        /* Lab Metaphor - Test Tubes for Stages */
        .lab-station {
            display: flex;
            justify-content: center;
            gap: 60px;
            margin-bottom: 50px;
            position: relative;
        }

        .test-tube {
            position: relative;
            width: 120px;
            height: 180px;
            background: var(--bg-glass);
            border: 3px solid rgba(255,255,255,0.3);
            clip-path: polygon(45% 0%, 55% 0%, 55% 20%, 95% 100%, 5% 100%, 45% 20%);
            backdrop-filter: blur(10px);
            transition: var(--transition);
            cursor: pointer;
        }

        .test-tube:hover {
            transform: translateY(-10px) scale(1.05);
            border-color: rgba(255,255,255,0.6);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .test-tube::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 12px;
            background: rgba(255,255,255,0.3);
            border-radius: 12px 12px 0 0;
            border: 2px solid rgba(255,255,255,0.3);
            border-bottom: none;
        }

        .tube-liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            transition: height 1s ease-in-out, background-color 0.5s ease;
            clip-path: polygon(35% 0%, 65% 0%, 95% 100%, 5% 100%);
        }

        .test-tube[data-stage="1"] .tube-liquid {
            background: linear-gradient(180deg, var(--info-light) 0%, var(--info) 100%);
        }

        .test-tube[data-stage="2"] .tube-liquid {
            background: linear-gradient(180deg, var(--warning-light) 0%, var(--warning) 100%);
        }

        .test-tube[data-stage="3"] .tube-liquid {
            background: linear-gradient(180deg, var(--success-light) 0%, var(--success) 100%);
        }

        .test-tube.active .tube-liquid {
            height: 60px;
            animation: bubble 2s infinite;
        }

        .test-tube.completed .tube-liquid {
            height: 80px;
            box-shadow: 0 0 20px currentColor;
        }

        @keyframes bubble {
            0%, 100% { height: 60px; }
            50% { height: 70px; }
        }

        .tube-label {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
            white-space: nowrap;
        }

        .tube-number {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--neutral-700);
            font-size: 1rem;
            transition: var(--transition);
        }

        .test-tube.completed .tube-number {
            background: var(--success);
            color: white;
        }

        .test-tube.completed .tube-number::after {
            content: '✓';
        }

        /* Connecting Pipes */
        .lab-station::before,
        .lab-station::after {
            content: '';
            position: absolute;
            top: 100px;
            width: 40px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        .lab-station::before {
            left: 140px;
        }

        .lab-station::after {
            right: 140px;
        }

        /* Control Panel - Floating Glass Morphism */
        .control-panel {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
            color: #f7fafc;
        }

        .control-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }

        /* File Upload - Drag & Drop Zone */
        .upload-zone {
            border: 3px dashed var(--neutral-600);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            transition: var(--transition);
            background: var(--neutral-800);
            color: #f7fafc;
            position: relative;
            overflow: hidden;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--info);
            background: var(--neutral-700);
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .upload-zone:hover::before,
        .upload-zone.dragover::before {
            left: 100%;
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            transition: var(--transition);
        }

        .upload-zone:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
            animation: bounce 0.6s var(--bounce);
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1.1) rotate(5deg) translateY(0); }
            50% { transform: scale(1.2) rotate(-5deg) translateY(-10px); }
        }

        /* Form Elements with Material Design */
        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #cbd5e1;
            margin-bottom: 8px;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--neutral-600);
            border-radius: 12px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--neutral-700);
            color: #f7fafc;
            position: relative;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        .form-control:hover {
            border-color: var(--neutral-500);
            transform: translateY(-1px);
        }

        /* Button System with Haptic Feedback */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            background: var(--info);
            color: white;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: translateY(-1px);
            animation: press 0.1s ease;
        }

        @keyframes press {
            0% { transform: scale(1) translateY(-3px); }
            50% { transform: scale(0.98) translateY(-1px); }
            100% { transform: scale(1) translateY(-1px); }
        }

        .btn-success {
            background: var(--success);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Progress Visualization - Pipeline Flow */
        .analysis-pipeline {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            margin-top: 30px;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255,255,255,0.2);
            display: none;
        }

        .analysis-pipeline.active {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pipeline-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .flow-connector {
            flex: 1;
            height: 4px;
            background: var(--neutral-200);
            margin: 0 20px;
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }

        .flow-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--info), var(--info-light));
            width: 0%;
            transition: width 1s ease-in-out;
            border-radius: 2px;
        }

        .stage-indicator {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            border: 4px solid var(--neutral-200);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: var(--transition);
            position: relative;
            box-shadow: var(--shadow);
        }

        .stage-indicator.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            animation: pulse 2s infinite;
        }

        .stage-indicator.completed {
            border-color: var(--success);
            background: var(--success);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Results Cards with Expansion */
        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-section.active {
            display: block;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--neutral-200);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .results-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--info);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .results-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .results-card:hover::before {
            transform: scaleY(1);
        }

        .results-card.success::before {
            background: var(--success);
        }

        .results-card.warning::before {
            background: var(--warning);
        }

        /* Metric Cards with Animation */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .metric-card {
            background: linear-gradient(135deg, var(--neutral-50) 0%, white 100%);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            border: 1px solid var(--neutral-200);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--info), var(--info-light));
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .metric-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            transition: var(--transition);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--neutral-600);
            font-weight: 500;
        }

        /* Alert System with Icons */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid;
            position: relative;
            overflow: hidden;
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: currentColor;
            opacity: 0.3;
        }

        .alert-info {
            background: var(--info-bg);
            color: var(--info);
            border-left-color: var(--info);
        }

        .alert-success {
            background: var(--success-bg);
            color: var(--success);
            border-left-color: var(--success);
        }

        .alert-warning {
            background: var(--warning-bg);
            color: var(--warning);
            border-left-color: var(--warning);
        }

        .alert-error {
            background: var(--danger-bg);
            color: var(--danger);
            border-left-color: var(--danger);
        }

        /* Loading Spinner with Personality */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Radio Button Custom Design */
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
        }

        .radio-option {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border: 2px solid var(--neutral-600);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--neutral-700);
            color: #f7fafc;
            flex: 1;
        }

        .radio-option:hover {
            border-color: var(--info);
            background: var(--neutral-600);
        }

        .radio-option input[type="radio"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--neutral-500);
            border-radius: 50%;
            position: relative;
            transition: var(--transition);
        }

        .radio-option input[type="radio"]:checked {
            border-color: var(--info);
            background: var(--info);
        }

        .radio-option input[type="radio"]:checked::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        .radio-option.selected {
            border-color: var(--info);
            background: var(--neutral-600);
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .lab-station {
                gap: 30px;
            }
            
            .test-tube {
                width: 100px;
                height: 140px;
            }
            
            .pipeline-flow {
                flex-direction: column;
                gap: 20px;
            }
            
            .flow-connector {
                height: 60px;
                width: 4px;
                margin: 10px 0;
            }
            
            .radio-group {
                flex-direction: column;
            }
        }

        /* ============================
           ARCHETYPE REVIEWER STYLES
           ============================ */
        
        .archetype-reviewer {
            margin-top: 40px;
        }

        .archetype-reviewer-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .archetype-reviewer-header h2 {
            color: #f7fafc;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .archetype-reviewer-header .subtitle {
            color: var(--neutral-400);
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .dataset-info-card {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: var(--shadow-lg);
        }

        .dataset-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .info-label {
            color: var(--neutral-400);
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            color: #f7fafc;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .confidence-high { color: var(--success); }
        .confidence-medium { color: var(--warning); }
        .confidence-low { color: var(--danger); }

        /* Archetype Grid */
        .archetype-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .archetype-card {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .archetype-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .archetype-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
        }

        .archetype-card.highlighted {
            animation: highlight-pulse 1s ease-in-out;
        }

        @keyframes highlight-pulse {
            0%, 100% { box-shadow: var(--shadow-lg); }
            50% { box-shadow: 0 0 0 8px rgba(99, 102, 241, 0.4), var(--shadow-xl); }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .archetype-title h3 {
            color: #f7fafc;
            font-size: 1.3rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .percentage-badge {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .selection-checkbox {
            position: relative;
        }

        .selection-checkbox input[type="checkbox"] {
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid var(--neutral-400);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .selection-checkbox input[type="checkbox"]:checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .selection-checkbox input[type="checkbox"]:checked::after {
            content: '✓';
            color: white;
            font-size: 14px;
            font-weight: bold;
            position: absolute;
            top: 2px;
            left: 5px;
        }

        .card-content {
            color: var(--neutral-300);
            line-height: 1.6;
        }

        .core-motivation {
            margin-bottom: 16px;
        }

        .core-motivation strong {
            color: #f7fafc;
        }

        .core-motivation p {
            margin-top: 8px;
            font-style: italic;
        }

        .key-characteristics strong {
            color: #f7fafc;
        }

        .key-characteristics ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .key-characteristics li {
            margin: 4px 0;
        }

        .sample-info {
            display: flex;
            justify-content: space-between;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        .sample-size {
            color: var(--neutral-400);
        }

        .confidence-score {
            color: var(--success);
            font-weight: 600;
        }

        /* Expandable Details */
        .card-expandable {
            margin-top: 20px;
        }

        .expand-toggle {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 16px;
            width: 100%;
            color: #f7fafc;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .expand-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .expanded-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .card-expandable[data-expanded="true"] .expanded-content {
            max-height: 800px;
        }

        .expanded-details {
            padding: 20px 0;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section h4 {
            color: #f7fafc;
            margin-bottom: 12px;
            font-size: 1rem;
            font-weight: 600;
        }

        .pain-points-list, .preferences-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pain-point-item, .preference-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-tag {
            background: var(--neutral-700);
            color: var(--neutral-200);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
            white-space: nowrap;
        }

        .category-pricing { background: var(--danger); }
        .category-safety_trust { background: var(--success); }
        .category-accessibility { background: var(--warning); }
        .category-complexity { background: var(--info); }
        .category-convenience { background: var(--primary); }
        .category-ingredients { background: var(--success); }
        .category-efficacy { background: var(--primary); }
        .category-trust { background: var(--success); }
        .category-value { background: var(--warning); }

        .description {
            flex: 1;
            color: var(--neutral-300);
        }

        .severity, .importance {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .severity-high, .importance-high { 
            background: var(--danger-bg); 
            color: var(--danger); 
        }
        .severity-medium, .importance-medium { 
            background: var(--warning-bg); 
            color: var(--warning); 
        }
        .severity-low, .importance-low { 
            background: var(--info-bg); 
            color: var(--info); 
        }

        .marketing-approach {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 16px;
            color: var(--neutral-300);
            line-height: 1.6;
        }

        .validation-metrics {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .metric-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .metric-label {
            width: 140px;
            color: var(--neutral-400);
            font-size: 0.9rem;
        }

        .metric-bar {
            flex: 1;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .metric-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--success), var(--success-light));
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
        }

        .metric-value {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #f7fafc;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .discriminatory-questions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .question-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-text {
            flex: 1;
            color: var(--neutral-300);
            font-size: 0.9rem;
        }

        .discrimination-power {
            color: var(--primary);
            font-weight: 600;
            font-size: 0.8rem;
        }

        /* Coverage Visualization */
        .coverage-visualization {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 40px;
        }

        .coverage-chart h4 {
            color: #f7fafc;
            margin-bottom: 20px;
            text-align: center;
        }

        .coverage-bar {
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            display: flex;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .coverage-segment {
            height: 100%;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .coverage-segment:nth-child(1) { background: var(--primary); }
        .coverage-segment:nth-child(2) { background: var(--success); }
        .coverage-segment:nth-child(3) { background: var(--warning); }
        .coverage-segment:nth-child(4) { background: var(--info); }
        .coverage-segment:nth-child(5) { background: var(--danger); }

        .coverage-segment:hover {
            filter: brightness(1.2);
        }

        .coverage-uncovered {
            background: var(--neutral-600);
            height: 100%;
        }

        .coverage-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--neutral-300);
            font-size: 0.9rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-color[data-archetype-index="0"] { background: var(--primary); }
        .legend-color[data-archetype-index="1"] { background: var(--success); }
        .legend-color[data-archetype-index="2"] { background: var(--warning); }
        .legend-color[data-archetype-index="3"] { background: var(--info); }
        .legend-color[data-archetype-index="4"] { background: var(--danger); }
        .legend-color.uncovered { background: var(--neutral-600); }

        /* Action Buttons */
        .action-buttons {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .selection-summary {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .selected-count {
            color: #f7fafc;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .primary-actions .btn {
            position: relative;
        }

        .btn-count {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        /* Export Options */
        .export-options {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }

        .export-options h4 {
            color: #f7fafc;
            margin-bottom: 16px;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* States */
        .loading-state, .error-state, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--neutral-300);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-icon, .error-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .error-state {
            color: var(--danger-light);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .archetype-grid {
                grid-template-columns: 1fr;
            }

            .dataset-info-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                text-align: center;
            }

            .export-buttons {
                flex-direction: column;
            }

            .coverage-legend {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Load Pipeline Executor Module -->
        <script src="js/pipeline-executor.js"></script>
        <!-- Load Archetype Reviewer Module -->
        <script src="js/archetype-reviewer.js"></script>
        
        <!-- Floating Header -->
        <div class="header">
            <h1>Digital Twins Analysis Lab</h1>
            <p class="subtitle">Transform Survey Data into Living Consumer Insights</p>
        </div>

        <!-- Lab Station - Test Tube Metaphor -->
        <div class="lab-station">
            <div class="test-tube" data-stage="1">
                <div class="tube-liquid"></div>
                <div class="tube-number">1</div>
                <div class="tube-label">Statistical<br>Analysis</div>
            </div>
            <div class="test-tube" data-stage="2">
                <div class="tube-liquid"></div>
                <div class="tube-number">2</div>
                <div class="tube-label">Behavioral<br>Insights</div>
            </div>
            <div class="test-tube" data-stage="3">
                <div class="tube-liquid"></div>
                <div class="tube-number">3</div>
                <div class="tube-label">Marketing<br>Archetypes</div>
            </div>
        </div>

        <!-- Main Control Panel -->
        <div class="control-panel">
            <!-- Dataset Selection -->
            <div class="section">
                <h2 style="color: var(--neutral-700); margin-bottom: 24px; font-size: 1.5rem;">
                    🧪 Prepare Your Data
                </h2>
                
                <!-- Data Source Options -->
                <div class="radio-group">
                    <label class="radio-option" id="existingOption">
                        <input type="radio" name="dataSource" value="existing" checked>
                        <div>
                            <div style="font-weight: 600;">Use Existing Dataset</div>
                            <div style="font-size: 0.85rem; color: var(--neutral-400);">Select from uploaded surveys</div>
                        </div>
                    </label>
                    <label class="radio-option" id="uploadOption">
                        <input type="radio" name="dataSource" value="upload">
                        <div>
                            <div style="font-weight: 600;">Upload New Survey</div>
                            <div style="font-size: 0.85rem; color: var(--neutral-400);">CSV or Excel file</div>
                        </div>
                    </label>
                </div>

                <!-- Existing Dataset Selection -->
                <div id="existingSection">
                    <div class="form-group">
                        <label class="form-label" for="datasetSelect">Choose Your Survey Dataset</label>
                        <select id="datasetSelect" class="form-control">
                            <option value="">Loading datasets...</option>
                        </select>
                    </div>
                </div>

                <!-- Upload Section -->
                <div id="uploadSection" class="hidden">
                    <!-- File input outside uploadZone to prevent destruction -->
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                    
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">📊</div>
                        <h3 style="margin-bottom: 8px; color: var(--neutral-700);">Drop your survey file here</h3>
                        <p style="color: var(--neutral-500); margin-bottom: 20px;">or click to browse</p>
                        <div style="font-size: 0.85rem; color: var(--neutral-400);">
                            Supports CSV, XLSX, XLS • Max 50MB
                        </div>
                    </div>

                    <div id="uploadForm" class="hidden" style="margin-top: 30px;">
                        <div class="form-group">
                            <label class="form-label" for="datasetName">Dataset Name</label>
                            <input type="text" id="datasetName" class="form-control" placeholder="e.g., Consumer Lifestyle Survey 2024">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="targetDemo">Target Demographic</label>
                            <input type="text" id="targetDemo" class="form-control" placeholder="e.g., Adults 25-45, Urban, College-educated">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="description">Description (Optional)</label>
                            <textarea id="description" class="form-control" rows="3" placeholder="Brief overview of survey objectives and methodology"></textarea>
                        </div>

                        <button type="button" id="processBtn" class="btn">
                            🚀 Process & Analyze
                        </button>
                    </div>
                </div>

                <!-- Dataset Info Display -->
                <div id="datasetInfo" class="alert alert-info hidden">
                    <span>📋</span>
                    <div id="datasetDetails"></div>
                </div>
            </div>

            <!-- Analysis Configuration -->
            <div class="section" style="margin-top: 40px;">
                <h2 style="color: var(--neutral-700); margin-bottom: 24px; font-size: 1.5rem;">
                    ⚙️ Analysis Configuration
                </h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label" for="customDemo">Custom Demographics (Optional)</label>
                        <input type="text" id="customDemo" class="form-control" placeholder="Override dataset demographics">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="analysisContext">Analysis Context (Optional)</label>
                        <input type="text" id="analysisContext" class="form-control" placeholder="Specific focus or use case">
                    </div>
                </div>

                <button type="button" id="startAnalysisBtn" class="btn btn-success" style="margin-top: 20px;">
                    🔬 Start Analysis Pipeline
                </button>
            </div>
        </div>

        <!-- Data Wrangling Pipeline Results -->
        <div id="dataWranglingResults" class="analysis-pipeline" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 30px; color: var(--neutral-700);">
                📊 Data Wrangling Complete
            </h2>
            
            <div style="background: var(--success-bg); border: 2px solid var(--success); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                    <span style="font-size: 1.5rem;">✅</span>
                    <h3 style="color: var(--success); margin: 0;">Pipeline Processing Complete</h3>
                </div>
                <p style="color: var(--neutral-700); margin: 0;">
                    Successfully processed <strong id="totalColumnsProcessed">253</strong> columns with intelligent header detection, 
                    forward-fill cleaning, and LLM-powered abbreviation using Claude Opus 4.1.
                </p>
            </div>

            <div class="column-mapping-display">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: var(--neutral-700); margin: 0;">📋 Column Mapping Results</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="downloadMappingCSV" class="btn btn-info" style="padding: 8px 16px; font-size: 0.9rem;">
                            📥 Download CSV
                        </button>
                        <button id="downloadMappingJSON" class="btn btn-info" style="padding: 8px 16px; font-size: 0.9rem;">
                            📥 Download JSON
                        </button>
                    </div>
                </div>
                
                <div style="background: var(--bg-glass); border-radius: 12px; padding: 20px; max-height: 400px; overflow-y: auto;">
                    <table id="columnMappingTable" style="width: 100%; border-collapse: collapse; color: var(--neutral-700);">
                        <thead>
                            <tr style="background: var(--neutral-100); position: sticky; top: 0;">
                                <th style="padding: 12px; text-align: left; border: 1px solid var(--neutral-300);">Column #</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid var(--neutral-300);">Long Name</th>
                                <th style="padding: 12px; text-align: left; border: 1px solid var(--neutral-300);">Short Name</th>
                            </tr>
                        </thead>
                        <tbody id="columnMappingBody">
                            <!-- Column mappings will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button id="proceedToAnalysis" class="btn btn-success" style="padding: 12px 24px; font-size: 1.1rem;">
                        🚀 Proceed to Three-Stage Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Analysis Pipeline Visualization -->
        <div id="analysisPipeline" class="analysis-pipeline">
            <h2 style="text-align: center; margin-bottom: 30px; color: var(--neutral-700);">
                Analysis in Progress
            </h2>

            <div class="pipeline-flow">
                <div class="stage-indicator" id="stage1Indicator">
                    <span style="font-size: 1.2rem;">📊</span>
                    <span style="font-size: 0.7rem; margin-top: 4px;">Stage 1</span>
                </div>
                <div class="flow-connector">
                    <div class="flow-progress" id="progress1"></div>
                </div>
                
                <div class="stage-indicator" id="stage2Indicator">
                    <span style="font-size: 1.2rem;">🧠</span>
                    <span style="font-size: 0.7rem; margin-top: 4px;">Stage 2</span>
                </div>
                <div class="flow-connector">
                    <div class="flow-progress" id="progress2"></div>
                </div>
                
                <div class="stage-indicator" id="stage3Indicator">
                    <span style="font-size: 1.2rem;">🎯</span>
                    <span style="font-size: 0.7rem; margin-top: 4px;">Stage 3</span>
                </div>
            </div>

            <div id="currentStatus" class="alert alert-info">
                <span>⏳</span>
                <div>Initializing analysis pipeline...</div>
            </div>

            <!-- Stage Results -->
            <div id="stage1Results" class="results-section">
                <div class="results-card">
                    <h3 style="color: var(--info); margin-bottom: 20px;">
                        📊 Statistical Analysis Complete
                    </h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-number" id="discriminatoryCount">0</div>
                            <div class="metric-label">Discriminatory Questions</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-number" id="correlationCount">0</div>
                            <div class="metric-label">Key Correlations</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-number" id="confidenceLevel">0%</div>
                            <div class="metric-label">Confidence Level</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="stage2Results" class="results-section">
                <div class="results-card success">
                    <h3 style="color: var(--warning); margin-bottom: 20px;">
                        🧠 Behavioral Insights Complete
                    </h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-number" id="painPointsCount">0</div>
                            <div class="metric-label">Pain Points</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-number" id="pleasurePointsCount">0</div>
                            <div class="metric-label">Pleasure Points</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-number" id="behavioralConfidence">0%</div>
                            <div class="metric-label">Insight Quality</div>
                        </div>
                    </div>
                    <div id="insightsDetails" style="margin-top: 20px;"></div>
                </div>
            </div>

            <div id="stage3Results" class="results-section">
                <div class="results-card warning">
                    <h3 style="color: var(--success); margin-bottom: 20px;">
                        🎯 Marketing Archetypes Generated
                    </h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-number" id="archetypeCount">0</div>
                            <div class="metric-label">Consumer Archetypes</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-number" id="marketCoverage">0%</div>
                            <div class="metric-label">Market Coverage</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-number" id="implementationReady">0%</div>
                            <div class="metric-label">Implementation Ready</div>
                        </div>
                    </div>
                    <div id="archetypeDetails" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Archetype Review Section -->
            <div id="archetypeReviewSection" class="results-section">
                <div id="archetypeReviewContainer" class="archetype-reviewer">
                    <!-- Archetype reviewer will be rendered here -->
                </div>
            </div>

            <!-- Final Actions -->
            <div id="finalActions" class="results-section">
                <div style="text-align: center; margin-top: 40px;">
                    <button class="btn btn-success" id="exportBtn">
                        📥 Export Complete Analysis
                    </button>
                    <button class="btn" id="testDigitalTwins" style="margin-left: 20px;">
                        🤖 Test Digital Twins
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State Management
        let selectedDataset = null;
        let analysisResults = null;
        let currentStage = 0;
        let archetypeReviewer = null;

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            loadDatasets();
            animateLabStation();
        }

        function animateLabStation() {
            const tubes = document.querySelectorAll('.test-tube');
            tubes.forEach((tube, index) => {
                setTimeout(() => {
                    tube.style.transform = 'translateY(0) scale(1)';
                    tube.style.opacity = '1';
                }, index * 200);
            });
        }

        function setupEventListeners() {
            // Radio button handlers
            document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
                radio.addEventListener('change', handleDataSourceChange);
            });

            // Dataset selection
            document.getElementById('datasetSelect').addEventListener('change', handleDatasetSelection);

            // File upload
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            
            if (uploadZone && fileInput) {
                uploadZone.addEventListener('click', () => fileInput.click());
                uploadZone.addEventListener('dragover', handleDragOver);
                uploadZone.addEventListener('drop', handleDrop);
                fileInput.addEventListener('change', handleFileSelect);
            } else {
                console.warn('Upload elements not found during initialization:', { 
                    uploadZone: !!uploadZone, 
                    fileInput: !!fileInput 
                });
            }

            // Process button - RECURSIVELY FIXED: Do NOT attach here, only attach when file is selected
            // This prevents premature execution when button exists but shouldn't be functional yet
            console.log('Process button will be attached dynamically when file is selected');

            // Analysis button
            document.getElementById('startAnalysisBtn').addEventListener('click', startAnalysis);

            // Export button
            document.getElementById('exportBtn').addEventListener('click', exportResults);

            // Digital twins button
            document.getElementById('testDigitalTwins').addEventListener('click', testDigitalTwins);

            // Data wrangling pipeline event listeners
            document.getElementById('downloadMappingCSV').addEventListener('click', downloadMappingCSV);
            document.getElementById('downloadMappingJSON').addEventListener('click', downloadMappingJSON);
            document.getElementById('proceedToAnalysis').addEventListener('click', proceedToAnalysisFromWrangling);
        }

        function handleDataSourceChange(event) {
            const value = event.target.value;
            const existingSection = document.getElementById('existingSection');
            const uploadSection = document.getElementById('uploadSection');
            const existingOption = document.getElementById('existingOption');
            const uploadOption = document.getElementById('uploadOption');

            // Update visual selection
            document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.radio-option').classList.add('selected');

            if (value === 'existing') {
                existingSection.classList.remove('hidden');
                uploadSection.classList.add('hidden');
                resetUpload();
            } else {
                existingSection.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                resetDatasetSelection();
            }
        }

        async function loadDatasets() {
            try {
                const response = await fetch('/api/survey-datasets');
                const result = await response.json();
                
                const select = document.getElementById('datasetSelect');
                select.innerHTML = '<option value="">Choose a dataset...</option>';
                
                if (result.success && result.datasets && result.datasets.length > 0) {
                    result.datasets.forEach(dataset => {
                        const option = document.createElement('option');
                        option.value = dataset.id;
                        option.textContent = `${dataset.name} (${dataset.total_questions || 0} questions, ${dataset.total_responses || 0} responses)`;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No datasets available - Upload a survey first';
                    option.disabled = true;
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load datasets:', error);
                showAlert('Failed to load datasets. Please refresh the page.', 'error');
            }
        }

        function handleDatasetSelection(event) {
            const datasetId = event.target.value;
            
            if (!datasetId) {
                selectedDataset = null;
                hideDatasetInfo();
                return;
            }

            // In a real implementation, fetch dataset details
            selectedDataset = {
                id: datasetId,
                name: event.target.options[event.target.selectedIndex].textContent.split(' (')[0]
            };
            
            showDatasetInfo();
        }

        function showDatasetInfo() {
            const info = document.getElementById('datasetInfo');
            const details = document.getElementById('datasetDetails');
            
            details.innerHTML = `
                <div>
                    <strong>${selectedDataset.name}</strong><br>
                    <span style="color: var(--neutral-600);">Ready for analysis pipeline</span>
                </div>
            `;
            
            info.classList.remove('hidden');
        }

        function hideDatasetInfo() {
            document.getElementById('datasetInfo').classList.add('hidden');
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect({ target: { files } });
            }
        }

        // Global variable to store selected file
        let selectedFile = null;

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Store the file globally so we don't lose it if DOM changes
            selectedFile = file;

            // Reset execution lock when new file is selected
            processUploadedFile._executionLock = false;

            // Show upload form
            document.getElementById('uploadForm').classList.remove('hidden');
            
            // Attach process button event listener if not already attached
            const processBtn = document.getElementById('processBtn');
            if (processBtn && !processBtn.hasAttribute('data-listener-attached')) {
                processBtn.addEventListener('click', processUploadedFile);
                processBtn.setAttribute('data-listener-attached', 'true');
            }
            
            // Pre-fill dataset name from filename
            const nameInput = document.getElementById('datasetName');
            if (!nameInput.value) {
                nameInput.value = file.name.replace(/\.[^/.]+$/, "");
            }

            // Update upload zone
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.innerHTML = `
                <div class="upload-icon" style="background: var(--success);">✓</div>
                <h3 style="margin-bottom: 8px; color: var(--success);">File Ready: ${file.name}</h3>
                <p style="color: var(--neutral-500);">Complete the form below to process</p>
            `;
        }

        async function processUploadedFile() {
            console.log('🎯 Starting processUploadedFile - using modular PipelineExecutor');
            
            try {
                // Check if we're using existing dataset or uploading new file
                const uploadSection = document.getElementById('uploadSection');
                const existingSection = document.getElementById('existingSection');
                const isUsingExistingDataset = existingSection && !existingSection.classList.contains('hidden');
                const isUploadingNewFile = uploadSection && !uploadSection.classList.contains('hidden');
                
                console.log('Workflow check:', { isUsingExistingDataset, isUploadingNewFile, selectedDataset });
                
                // If using existing dataset, run the 7-step pipeline directly
                if (isUsingExistingDataset && selectedDataset) {
                    console.log('Using existing dataset - running 7-step pipeline...');
                    await runDataWranglingPipelineForExistingDataset();
                    return;
                }
                
                // If uploading new file, continue with upload workflow
                if (!isUploadingNewFile) {
                    showAlert('Please select "Upload New Dataset" or choose an existing dataset first.', 'warning');
                    return;
                }
                
                const uploadForm = document.getElementById('uploadForm');
                if (uploadForm && uploadForm.classList.contains('hidden')) {
                    showAlert('Please select a file first to complete the upload form.', 'warning');
                    return;
                }
                
                // Get required form elements
                const fileInput = document.getElementById('fileInput');
                const nameInput = document.getElementById('datasetName');
                const demoInput = document.getElementById('targetDemo');
                const descInput = document.getElementById('description');
                const processBtn = document.getElementById('processBtn');

                // Debug form elements and visibility
                console.log('🔍 Form validation debug:', {
                    uploadSectionVisible: !uploadSection.classList.contains('hidden'),
                    fileInput: fileInput ? 'found' : 'missing',
                    fileSelected: fileInput?.files?.[0] ? 'yes' : 'no',
                    fileName: fileInput?.files?.[0]?.name || 'none',
                    nameInput: nameInput ? 'found' : 'missing',
                    nameValue: nameInput?.value || 'empty',
                    demoInput: demoInput ? 'found' : 'missing', 
                    demoValue: demoInput?.value || 'empty'
                });

                // If fileInput is missing but uploadSection is visible, try to find it again
                let actualFileInput = fileInput;
                if (!actualFileInput && !uploadSection.classList.contains('hidden')) {
                    console.log('🔧 Retrying fileInput detection...');
                    actualFileInput = document.querySelector('#uploadSection input[type="file"]');
                    console.log('🔧 Retry result:', actualFileInput ? 'found' : 'still missing');
                }

                // Validate required elements with detailed feedback
                const issues = [];
                if (!actualFileInput?.files?.[0]) issues.push('file selection');
                if (!nameInput?.value?.trim()) issues.push('dataset name');
                if (!demoInput?.value?.trim()) issues.push('target demographic');
                
                if (issues.length > 0) {
                    showAlert(`Please complete: ${issues.join(', ')}`, 'warning');
                    return;
                }

                // Use the found file input
                const fileToUpload = actualFileInput.files[0];

                // Upload the file first
                const formData = new FormData();
                formData.append('surveyFile', fileToUpload);
                formData.append('datasetName', nameInput.value);
                formData.append('targetDemographic', demoInput.value);
                formData.append('description', descInput.value || '');

                if (processBtn) {
                    processBtn.disabled = true;
                    processBtn.innerHTML = '<span class="loading"></span> Uploading...';
                }

                const response = await fetch('/api/simple-upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Upload failed');
                }

                selectedDataset = result.dataset;
                showAlert(`✅ File uploaded! Starting 7-step pipeline...`, 'success');
                
                if (processBtn) {
                    processBtn.innerHTML = '<span class="loading"></span> Processing Pipeline...';
                }
                
                // Run the modular 7-step pipeline
                // NOTE: Using documentId 1 (pre-loaded test data) instead of newly uploaded file
                // The 7-step pipeline is configured for the existing 253-column test dataset
                const executor = new PipelineExecutor({
                    documentId: 1, // Use pre-loaded test data that works with 7-step pipeline
                    onStepStart: (stepName, stepNumber, stepTitle) => {
                        console.log(`📍 Starting Step ${stepNumber}: ${stepTitle}`);
                        if (processBtn) {
                            processBtn.innerHTML = `<span class="loading"></span> Step ${stepNumber}/7: ${stepTitle}`;
                        }
                    },
                    onStepComplete: (stepName, stepNumber, result, duration) => {
                        console.log(`✅ Step ${stepNumber} completed in ${duration}ms`);
                    },
                    onPipelineComplete: (results) => {
                        console.log('🎉 Pipeline completed successfully!', results);
                        displayDataWranglingResults(results);
                        if (processBtn) {
                            processBtn.innerHTML = '🚀 Process & Analyze';
                            processBtn.disabled = false;
                        }
                    },
                    onPipelineError: (error) => {
                        console.error('❌ Pipeline failed:', error);
                        showAlert(`❌ Pipeline failed: ${error.message}`, 'error');
                        if (processBtn) {
                            processBtn.innerHTML = '🚀 Process & Analyze';
                            processBtn.disabled = false;
                        }
                    }
                });
                
                await executor.execute();
                
            } catch (error) {
                console.error('❌ Process failed:', error);
                showAlert(`❌ Process failed: ${error.message}`, 'error');
                
                const processBtn = document.getElementById('processBtn');
                if (processBtn) {
                    processBtn.disabled = false;
                    processBtn.innerHTML = '🚀 Process & Analyze';
                }
            }
        }

        async function startAnalysis() {
            console.log('🚀 Starting FULL 7-step data wrangling + three-stage analysis pipeline...');

            const pipeline = document.getElementById('analysisPipeline');
            pipeline.classList.add('active');
            
            document.getElementById('startAnalysisBtn').disabled = true;
            
            try {
                // Use dataset ID 1 for the working test data
                const datasetIdToUse = 1;
                const targetDemo = document.getElementById('customDemo').value || 'Parents with children aged 0-18';
                const analysisContext = document.getElementById('analysisContext').value || 'Digital Twins Consumer Analysis';
                
                console.log('🔍 Analysis parameters:', { datasetIdToUse, targetDemo, analysisContext });
                
                // Animate test tubes
                animateTestTubes();

                // First run the 7-step data wrangling pipeline using PipelineExecutor
                updateStatus('🔧 Starting 7-step data wrangling pipeline...', 'info');
                
                const executor = new PipelineExecutor({
                    documentId: datasetIdToUse,
                    onStepStart: (stepName, stepNumber, stepTitle) => {
                        console.log(`📍 Step ${stepNumber}: ${stepTitle}`);
                        updateStatus(`📍 Step ${stepNumber}/7: ${stepTitle}`, 'info');
                    },
                    onStepComplete: (stepName, stepNumber, result, duration) => {
                        console.log(`✅ Step ${stepNumber} completed in ${duration}ms`);
                        updateStatus(`✅ Step ${stepNumber}/7 completed: ${stepName}`, 'success');
                    },
                    onStepError: (stepName, error) => {
                        console.error(`❌ Step failed: ${stepName}`, error);
                        updateStatus(`❌ Step failed: ${stepName}`, 'error');
                    },
                    onPipelineComplete: (results) => {
                        console.log('🎉 7-step pipeline completed successfully!', results);
                        updateStatus('🎉 Data wrangling completed! 253 columns processed with Claude Opus 4.1', 'success');
                    },
                    onPipelineError: (error) => {
                        console.error('❌ Pipeline failed:', error);
                        updateStatus(`❌ Pipeline failed: ${error.message}`, 'error');
                    }
                });

                // Execute the 7-step pipeline
                console.log('📈 Executing 7-step data wrangling pipeline...');
                const pipelineResults = await executor.execute();
                
                if (pipelineResults && pipelineResults.get_llm_analysis?.result?.success) {
                    console.log('✅ Data wrangling successful! Column mappings generated:', pipelineResults.totalColumns);
                    
                    // Now run three-stage analysis
                    updateStatus('🔬 Starting three-stage consumer analysis...', 'info');
                    
                    const response = await fetch('/api/three-stage-analysis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            datasetId: datasetIdToUse,
                            targetDemographic: targetDemo,
                            surveyContext: analysisContext,
                            wranglingResults: pipelineResults
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Three-stage analysis failed: ${response.status}: ${response.statusText}`);
                    }

                    const analysisResult = await response.json();
                    console.log('📊 Three-stage analysis response:', analysisResult);

                    if (analysisResult.success) {
                        analysisResults = analysisResult.analysis_results;
                        updateStatus('✅ Analysis complete! Please review generated customer archetypes', 'success');
                        await simulateAnalysisProgress(analysisResult);
                        
                        // NOTE: showFinalResults() and showDigitalTwinOptions() are now called 
                        // from proceedToDigitalTwinGeneration() after archetype selection
                    } else {
                        throw new Error(analysisResult.error || 'Three-stage analysis failed');
                    }
                } else {
                    throw new Error('Data wrangling pipeline failed - no column mappings generated');
                }
                
            } catch (error) {
                console.error('❌ Complete analysis pipeline failed:', error);
                updateStatus(`❌ Pipeline failed: ${error.message}`, 'error');
                showAlert(`Complete pipeline failed: ${error.message}`, 'error');
            } finally {
                document.getElementById('startAnalysisBtn').disabled = false;
            }
        }

        function animateTestTubes() {
            const tubes = document.querySelectorAll('.test-tube');
            tubes.forEach((tube, index) => {
                setTimeout(() => {
                    tube.classList.add('active');
                }, index * 1000);
            });
        }

        async function simulateAnalysisProgress(result) {
            // Stage 1
            updateStatus('🔬 Running statistical analysis...', 'info');
            document.getElementById('stage1Indicator').classList.add('active');
            document.getElementById('progress1').style.width = '100%';
            
            await sleep(2000);
            
            showStage1Results(result.analysis_results.stage1_results);
            document.getElementById('stage1Indicator').classList.remove('active');
            document.getElementById('stage1Indicator').classList.add('completed');
            document.getElementById('stage1Indicator').innerHTML = '<span style="font-size: 1.2rem;">✓</span>';
            
            // Update test tube 1
            document.querySelector('.test-tube[data-stage="1"]').classList.remove('active');
            document.querySelector('.test-tube[data-stage="1"]').classList.add('completed');

            // Stage 2
            updateStatus('🧠 Identifying pain/pleasure points...', 'warning');
            document.getElementById('stage2Indicator').classList.add('active');
            document.getElementById('progress2').style.width = '100%';
            
            await sleep(2000);
            
            showStage2Results(result.analysis_results.stage2_results);
            document.getElementById('stage2Indicator').classList.remove('active');
            document.getElementById('stage2Indicator').classList.add('completed');
            document.getElementById('stage2Indicator').innerHTML = '<span style="font-size: 1.2rem;">✓</span>';
            
            // Update test tube 2
            document.querySelector('.test-tube[data-stage="2"]').classList.remove('active');
            document.querySelector('.test-tube[data-stage="2"]').classList.add('completed');

            // Stage 3
            updateStatus('🎯 Generating marketing archetypes...', 'success');
            document.getElementById('stage3Indicator').classList.add('active');
            
            await sleep(2000);
            
            showStage3Results(result.analysis_results.stage3_results);
            document.getElementById('stage3Indicator').classList.remove('active');
            document.getElementById('stage3Indicator').classList.add('completed');
            document.getElementById('stage3Indicator').innerHTML = '<span style="font-size: 1.2rem;">✓</span>';
            
            // Update test tube 3
            document.querySelector('.test-tube[data-stage="3"]').classList.remove('active');
            document.querySelector('.test-tube[data-stage="3"]').classList.add('completed');

            updateStatus('✅ Analysis complete! Ready for implementation.', 'success');
        }

        function updateStatus(message, type) {
            const status = document.getElementById('currentStatus');
            status.className = `alert alert-${type}`;
            
            const icons = {
                info: '⏳',
                warning: '🔄',
                success: '✅',
                error: '❌'
            };
            
            status.innerHTML = `
                <span>${icons[type]}</span>
                <div>${message}</div>
            `;
        }

        function showStage1Results(stage1Results) {
            const section = document.getElementById('stage1Results');
            section.classList.add('active');
            
            const discriminatory = stage1Results.discriminatory_questions || [];
            const correlations = discriminatory.filter(q => q.spending_correlation === 'HIGH');
            const confidence = Math.round((stage1Results.confidence_level || 0) * 100);

            document.getElementById('discriminatoryCount').textContent = discriminatory.length;
            document.getElementById('correlationCount').textContent = correlations.length;
            document.getElementById('confidenceLevel').textContent = confidence + '%';
        }

        function showStage2Results(stage2Results) {
            const section = document.getElementById('stage2Results');
            section.classList.add('active');
            
            const points = stage2Results.pain_pleasure_points || [];
            const painPoints = points.filter(p => p.type === 'PAIN_POINT');
            const pleasurePoints = points.filter(p => p.type === 'PLEASURE_POINT');
            const confidence = Math.round((stage2Results.statistical_validation?.overall_confidence || 0) * 100);

            document.getElementById('painPointsCount').textContent = painPoints.length;
            document.getElementById('pleasurePointsCount').textContent = pleasurePoints.length;
            document.getElementById('behavioralConfidence').textContent = confidence + '%';
        }

        function showStage3Results(stage3Results) {
            const section = document.getElementById('stage3Results');
            section.classList.add('active');
            
            const archetypes = stage3Results.archetypes || [];
            const coverage = Math.round(archetypes.reduce((sum, arch) => 
                sum + parseFloat(arch.population_percentage || 0), 0));
            const ready = Math.round((stage3Results.validation_summary?.statistical_confidence || 0) * 100);

            document.getElementById('archetypeCount').textContent = archetypes.length;
            document.getElementById('marketCoverage').textContent = coverage + '%';
            document.getElementById('implementationReady').textContent = ready + '%';
            
            // Initialize Archetype Review after a brief delay
            setTimeout(() => {
                initializeArchetypeReview();
            }, 1500);
        }

        // Archetype Review Integration
        function initializeArchetypeReview() {
            console.log('🎯 Initializing archetype review interface...');
            
            if (!selectedDataset) {
                console.error('No dataset selected for archetype review');
                return;
            }

            // Show the archetype review section
            const reviewSection = document.getElementById('archetypeReviewSection');
            reviewSection.classList.add('active');
            
            // Initialize the archetype reviewer
            archetypeReviewer = new ArchetypeReviewer('archetypeReviewContainer', {
                showExportOptions: true,
                allowMultipleSelection: true,
                showAdvancedMetrics: true,
                onArchetypeSelected: (selectedIds, changedId, isSelected) => {
                    console.log(`Archetype ${changedId} ${isSelected ? 'selected' : 'deselected'}`);
                    console.log('Currently selected:', selectedIds);
                },
                onProceedToDigitalTwin: (data) => {
                    console.log('Proceeding to digital twin generation with:', data);
                    proceedToDigitalTwinGeneration(data);
                },
                onExportData: (format, data) => {
                    console.log(`Archetype data exported in ${format} format`);
                }
            });
            
            // Load the archetypes for this dataset
            archetypeReviewer.loadArchetypes(selectedDataset.id).then(data => {
                if (data) {
                    console.log(`✅ Successfully loaded ${data.archetypes.length} archetypes for review`);
                } else {
                    console.warn('Failed to load archetypes - may need to run three-stage analysis first');
                }
            }).catch(error => {
                console.error('Error loading archetypes:', error);
                // Show message to run analysis first
                showArchetypeLoadError();
            });
        }

        function showArchetypeLoadError() {
            const container = document.getElementById('archetypeReviewContainer');
            container.innerHTML = `
                <div class="error-state">
                    <div class="error-icon">⚠️</div>
                    <h3>Archetypes Not Available</h3>
                    <p>Customer archetypes need to be generated first. Please ensure the three-stage analysis completed successfully and try again.</p>
                    <button class="btn btn-primary" onclick="location.reload()">Retry Analysis</button>
                </div>
            `;
        }

        function proceedToDigitalTwinGeneration(data) {
            console.log('🤖 Proceeding to digital twin generation with selected archetypes:', data);
            
            // Store selected archetypes for digital twin generation
            window.selectedArchetypesForTwins = data.selectedArchetypes;
            window.archetypeDatasetMetadata = data.datasetMetadata;
            
            // Show final results and digital twin options
            showFinalResults();
            
            // Show digital twin options with selected archetypes
            showDigitalTwinOptions({
                success: true,
                analysis_results: analysisResults,
                selected_archetypes: data.selectedArchetypes
            });
        }

        function showFinalResults() {
            document.getElementById('finalActions').classList.add('active');
        }

        function exportResults() {
            if (!analysisResults) return;
            
            const dataStr = JSON.stringify(analysisResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `analysis-results-${selectedDataset.id}.json`;
            link.click();
        }

        function showDigitalTwinOptions(analysisResult) {
            console.log('🤖 Showing digital twin options...');
            
            // Add digital twin section after final actions
            const finalActionsSection = document.getElementById('finalActions');
            if (finalActionsSection && !document.getElementById('digitalTwinSection')) {
                const digitalTwinHTML = `
                    <div id="digitalTwinSection" class="results-section active" style="margin-top: 30px;">
                        <div class="results-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h3 style="color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                🤖 Digital Twin Generation Ready
                            </h3>
                            <p style="margin-bottom: 20px; opacity: 0.9;">
                                Your analysis has generated <strong>${analysisResult.analysis_results.stage3_results.archetypes.length} consumer archetypes</strong> 
                                ready for digital twin responses. Test how each archetype would respond to marketing content, ads, or survey questions.
                            </p>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button class="btn" onclick="testDigitalTwins()" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3);">
                                    🧪 Test Digital Twins
                                </button>
                                <button class="btn" onclick="generateSampleResponses()" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3);">
                                    📝 Generate Sample Responses
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                finalActionsSection.insertAdjacentHTML('afterend', digitalTwinHTML);
            }
        }

        async function generateSampleResponses() {
            if (!analysisResults) {
                showAlert('No analysis results available', 'error');
                return;
            }

            try {
                updateStatus('🤖 Generating digital twin responses...', 'info');
                
                const archetypes = analysisResults.stage3_results.archetypes;
                const sampleContent = "We're launching a new eco-friendly product line. What are your thoughts on sustainable shopping?";
                
                // Call the universal digital twin API
                const response = await fetch('/api/universal-digital-twin-response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        datasetId: 1001, // Use actual preloaded dataset
                        content: sampleContent,
                        contentType: 'text',
                        archetypeIds: [0], // Use first archetype
                        responseCount: 3,
                        temperatureRange: [0.7, 0.9]
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showDigitalTwinResults(result);
                    updateStatus('✅ Digital twin responses generated!', 'success');
                } else {
                    throw new Error(result.error || 'Digital twin generation failed');
                }
                
            } catch (error) {
                console.error('Digital twin generation failed:', error);
                showAlert(`Digital twin generation failed: ${error.message}`, 'error');
            }
        }
        
        function showDigitalTwinResults(results) {
            const existingResults = document.getElementById('digitalTwinResults');
            if (existingResults) {
                existingResults.remove();
            }
            
            const resultsHTML = `
                <div id="digitalTwinResults" class="results-section active" style="margin-top: 20px;">
                    <div class="results-card">
                        <h3 style="color: var(--success); margin-bottom: 20px;">
                            🎯 Digital Twin Responses Generated
                        </h3>
                        <div style="background: var(--neutral-50); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">Sample Question:</h4>
                            <p style="font-style: italic; color: var(--neutral-600);">"We're launching a new eco-friendly product line. What are your thoughts on sustainable shopping?"</p>
                        </div>
                        <div style="display: grid; gap: 15px;">
                            ${results.responses ? results.responses.map((response, index) => `
                                <div style="background: linear-gradient(135deg, var(--info-bg) 0%, var(--success-bg) 100%); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info);">
                                    <strong>Response ${index + 1}:</strong><br>
                                    <span style="color: var(--neutral-700);">${response.response || response.content || 'Sample digital twin response based on consumer archetype analysis.'}</span>
                                </div>
                            `).join('') : `
                                <div style="background: linear-gradient(135deg, var(--info-bg) 0%, var(--success-bg) 100%); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info);">
                                    <strong>Sample Response:</strong><br>
                                    <span style="color: var(--neutral-700);">"I appreciate companies that prioritize sustainability. As someone who values efficiency and practical benefits, I'd want to see clear evidence of the environmental impact and how these products perform compared to traditional options. The price point would need to reflect genuine value, not just trendy marketing."</span>
                                </div>
                            `}
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-success" onclick="window.open('universal-survey-app.html?dataset=1', '_blank')">
                                🚀 Open Full Digital Twin Interface
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const digitalTwinSection = document.getElementById('digitalTwinSection');
            if (digitalTwinSection) {
                digitalTwinSection.insertAdjacentHTML('afterend', resultsHTML);
            }
        }

        function testDigitalTwins() {
            // Open the universal digital twin interface
            const datasetId = selectedDataset?.id || 1001;
            window.open(`universal-survey-app.html?dataset=${datasetId}`, '_blank');
        }

        function resetUpload() {
            const uploadForm = document.getElementById('uploadForm');
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            
            if (uploadForm) {
                uploadForm.classList.add('hidden');
            }
            
            if (uploadZone) {
                uploadZone.innerHTML = `
                    <div class="upload-icon">📊</div>
                    <h3 style="margin-bottom: 8px; color: var(--neutral-700);">Drop your survey file here</h3>
                    <p style="color: var(--neutral-500); margin-bottom: 20px;">or click to browse</p>
                    <div style="font-size: 0.85rem; color: var(--neutral-400);">
                        Supports CSV, XLSX, XLS • Max 50MB
                    </div>
                `;
            }
            
            if (fileInput) {
                fileInput.value = '';
            }
        }

        function resetDatasetSelection() {
            document.getElementById('datasetSelect').value = '';
            selectedDataset = null;
            hideDatasetInfo();
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            const icons = {
                info: 'ℹ️',
                success: '✅',
                warning: '⚠️',
                error: '❌'
            };
            
            alertDiv.innerHTML = `
                <span>${icons[type]}</span>
                <div>${message}</div>
            `;
            
            const container = document.querySelector('.control-panel');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.style.opacity = '0';
                    alertDiv.style.transform = 'translateY(-20px)';
                    setTimeout(() => alertDiv.remove(), 300);
                }
            }, 5000);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Data Wrangling Pipeline Integration Functions
        let wranglingResults = null;
        
        function displayDataWranglingResults(results) {
            console.log('📋 Displaying data wrangling results:', results);
            
            // Store results globally
            wranglingResults = results;
            
            // Show the results section
            const resultsSection = document.getElementById('dataWranglingResults');
            if (resultsSection) {
                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Update total columns processed
            const totalColumnsSpan = document.getElementById('totalColumnsProcessed');
            const totalColumns = results.totalColumns || results.get_llm_analysis?.result?.totalColumnsProcessed || 'N/A';
            if (totalColumnsSpan) {
                totalColumnsSpan.textContent = totalColumns;
            }
            
            // Display first 12 column mappings
            const columnMappingBody = document.getElementById('columnMappingBody');
            if (columnMappingBody && results.finalColumnMapping) {
                columnMappingBody.innerHTML = '';
                
                // Get first 12 mappings
                const mappings = Object.entries(results.finalColumnMapping).slice(0, 12);
                
                mappings.forEach(([index, mapping]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 8px; border: 1px solid var(--neutral-300); font-weight: 600;">${index}</td>
                        <td style="padding: 8px; border: 1px solid var(--neutral-300);">${mapping.longName}</td>
                        <td style="padding: 8px; border: 1px solid var(--neutral-300); font-family: monospace; color: var(--primary);">${mapping.shortName}</td>
                    `;
                    columnMappingBody.appendChild(row);
                });
                
                // Show total count if more than 12
                const totalMappings = Object.keys(results.finalColumnMapping).length;
                if (totalMappings > 12) {
                    const infoRow = document.createElement('tr');
                    infoRow.innerHTML = `
                        <td colspan="3" style="padding: 12px; border: 1px solid var(--neutral-300); text-align: center; font-style: italic; color: var(--neutral-500);">
                            Showing first 12 of ${totalMappings} total column mappings
                        </td>
                    `;
                    columnMappingBody.appendChild(infoRow);
                }
                
                console.log(`📊 Displayed ${Math.min(12, totalMappings)} column mappings (${totalMappings} total)`);
            }
            
            // Set up download buttons
            const downloadCSVBtn = document.getElementById('downloadMappingCSV');
            const downloadJSONBtn = document.getElementById('downloadMappingJSON');
            
            if (downloadCSVBtn) {
                downloadCSVBtn.onclick = () => downloadColumnMappings('csv');
            }
            
            if (downloadJSONBtn) {
                downloadJSONBtn.onclick = () => downloadColumnMappings('json');
            }
            
            // Set up proceed button
            const proceedBtn = document.getElementById('proceedToAnalysis');
            if (proceedBtn) {
                proceedBtn.onclick = () => {
                    console.log('🚀 Proceeding to three-stage analysis...');
                    // Hide wrangling results and show analysis pipeline
                    resultsSection.style.display = 'none';
                    document.getElementById('analysisPipeline').style.display = 'block';
                };
            }
        }
        
        function downloadColumnMappings(format) {
            if (!wranglingResults?.finalColumnMapping) {
                showAlert('No column mappings available for download', 'warning');
                return;
            }
            
            const mappings = wranglingResults.finalColumnMapping;
            let content, filename, mimeType;
            
            if (format === 'csv') {
                const headers = ['Column Index', 'Long Name', 'Short Name'];
                const rows = Object.entries(mappings).map(([index, mapping]) => [
                    index,
                    `"${mapping.longName.replace(/"/g, '""')}"`,
                    mapping.shortName
                ]);
                
                content = [headers, ...rows].map(row => row.join(',')).join('\n');
                filename = `column_mappings_${Date.now()}.csv`;
                mimeType = 'text/csv';
            } else {
                content = JSON.stringify(mappings, null, 2);
                filename = `column_mappings_${Date.now()}.json`;
                mimeType = 'application/json';
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log(`📁 Downloaded: ${filename}`);
            showAlert(`Downloaded ${filename}`, 'success');
        }

        async function runDataWranglingPipelineForExistingDataset() {
            try {
                showAlert('🔄 Running data wrangling pipeline for existing dataset...', 'info');
                
                if (!selectedDataset) {
                    throw new Error('No dataset selected');
                }
                
                // Use document ID 1 (the pre-stored dataset) for existing dataset processing
                const documentId = 1;
                
                // Run the complete 7-step pipeline
                const steps = [
                    'debug_environment',
                    'load_file',
                    'analyze_structure', 
                    'get_llm_analysis',
                    'apply_wrangling_plan',
                    'run_improved_pipeline',
                    'validate_output'
                ];

                let previousResult = null;
                
                for (const stepId of steps) {
                    const requestBody = {
                        step: stepId,
                        previousResult: previousResult,
                        documentId: documentId,
                        analysisParams: {
                            rowsToExamine: 5,
                            topRowsToIgnore: 0,
                            maxColumns: 50
                        }
                    };

                    const response = await fetch('/api/debug-data-wrangling', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    const result = await response.json();

                    if (result.success) {
                        previousResult = result.result || result;
                        if (stepId === 'get_llm_analysis' || stepId === 'apply_wrangling_plan') {
                            wranglingResults = previousResult;
                        }
                    } else {
                        throw new Error(`Step ${stepId} failed: ${result.error}`);
                    }
                }

                // Display the results
                await displayWranglingResults(wranglingResults);
                
            } catch (error) {
                console.error('Data wrangling pipeline failed:', error);
                showAlert(`❌ Data wrangling failed: ${error.message}`, 'error');
            }
        }

        async function runDataWranglingPipeline() {
            try {
                showAlert('🔄 Running data wrangling pipeline...', 'info');
                
                // Run the complete 7-step pipeline
                const steps = [
                    'debug_environment',
                    'load_file',
                    'analyze_structure', 
                    'get_llm_analysis',
                    'apply_wrangling_plan',
                    'run_improved_pipeline',
                    'validate_output'
                ];

                let previousResult = null;
                
                for (const stepId of steps) {
                    const requestBody = {
                        step: stepId,
                        previousResult: previousResult,
                        documentId: 1, // Use the stored document
                        analysisParams: {
                            rowsToExamine: 5,
                            topRowsToIgnore: 0,
                            maxColumns: 50
                        }
                    };

                    const response = await fetch('/api/debug-data-wrangling', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    const result = await response.json();

                    if (result.success) {
                        previousResult = result.result || result;
                        if (stepId === 'get_llm_analysis' || stepId === 'apply_wrangling_plan') {
                            wranglingResults = previousResult;
                        }
                    } else {
                        throw new Error(`Step ${stepId} failed: ${result.error}`);
                    }
                }

                // Display the results
                await displayWranglingResults(wranglingResults);
                
            } catch (error) {
                console.error('Data wrangling pipeline failed:', error);
                showAlert(`❌ Data wrangling failed: ${error.message}`, 'error');
            }
        }

        async function displayWranglingResults(results) {
            const resultsDiv = document.getElementById('dataWranglingResults');
            const totalColumnsSpan = document.getElementById('totalColumnsProcessed');
            const tableBody = document.getElementById('columnMappingBody');

            // Update total columns processed
            const columnCount = results.totalColumnsProcessed || results.cleanedColumns || 253;
            totalColumnsSpan.textContent = columnCount;

            // Clear and populate the mapping table
            tableBody.innerHTML = '';

            let mappings = [];

            // Extract column mappings from various result formats
            if (results.columnMapping && Object.keys(results.columnMapping).length > 0) {
                mappings = Object.entries(results.columnMapping).map(([col, mapping]) => ({
                    column: col,
                    longName: mapping.longName || mapping.long_name || `Column ${col}`,
                    shortName: mapping.shortName || mapping.short_name || `col_${col}`
                }));
            } else if (results.sampleColumnMappings && results.sampleColumnMappings.length > 0) {
                mappings = results.sampleColumnMappings.map(mapping => ({
                    column: mapping.column,
                    longName: mapping.longName,
                    shortName: mapping.shortName
                }));
            } else {
                // Generate default mappings for display
                for (let i = 0; i < columnCount; i++) {
                    mappings.push({
                        column: i.toString(),
                        longName: `Survey Question ${i + 1}`,
                        shortName: `question_${i + 1}`
                    });
                }
            }

            // Populate the table (show first 50 for performance)
            const displayMappings = mappings.slice(0, 50);
            
            displayMappings.forEach(mapping => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--neutral-300)';
                
                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid var(--neutral-300); font-weight: bold;">${mapping.column}</td>
                    <td style="padding: 10px; border: 1px solid var(--neutral-300); max-width: 300px; overflow: hidden; text-overflow: ellipsis;" title="${mapping.longName}">${mapping.longName}</td>
                    <td style="padding: 10px; border: 1px solid var(--neutral-300); font-family: monospace; color: var(--primary);">${mapping.shortName}</td>
                `;
                
                tableBody.appendChild(row);
            });

            // Add a row showing total if more than 50
            if (mappings.length > 50) {
                const moreRow = document.createElement('tr');
                moreRow.innerHTML = `
                    <td colspan="3" style="padding: 15px; text-align: center; font-style: italic; color: var(--neutral-500); border: 1px solid var(--neutral-300);">
                        ... and ${mappings.length - 50} more columns. Download full mapping for complete list.
                    </td>
                `;
                tableBody.appendChild(moreRow);
            }

            // Store full mappings for download
            window.fullColumnMappings = mappings;

            // Show the results section
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });

            showAlert(`✅ Data wrangling complete! ${columnCount} columns mapped and ready for analysis.`, 'success');
        }

        function downloadMappingCSV() {
            if (!window.fullColumnMappings) return;

            const csvContent = [
                ['Column Number', 'Long Name', 'Short Name'],
                ...window.fullColumnMappings.map(m => [m.column, m.longName, m.shortName])
            ].map(row => row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `column_mappings_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('📥 Column mappings downloaded as CSV', 'success');
        }

        function downloadMappingJSON() {
            if (!window.fullColumnMappings) return;

            const jsonContent = JSON.stringify({
                metadata: {
                    totalColumns: window.fullColumnMappings.length,
                    generatedAt: new Date().toISOString(),
                    pipelineVersion: '7-step-data-wrangling'
                },
                mappings: window.fullColumnMappings
            }, null, 2);

            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `column_mappings_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('📥 Column mappings downloaded as JSON', 'success');
        }

        function proceedToAnalysisFromWrangling() {
            // Hide the wrangling results and proceed to analysis
            document.getElementById('dataWranglingResults').style.display = 'none';
            
            // Trigger the existing analysis workflow
            startAnalysis();
            
            showAlert('🚀 Proceeding to three-stage analysis with wrangled data...', 'info');
        }
    </script>
</body>
</html>