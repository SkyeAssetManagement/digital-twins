<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Parameter Testing - Digital Twin System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .column-container {
            transition: all 0.3s ease;
        }
        .parameter-group {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
        }
        .control-panel {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .active-column {
            border: 2px solid #4f46e5;
        }
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background-color: #6b7280;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
        }
        .info-icon:hover .tooltip {
            display: block;
        }
        .tooltip {
            display: none;
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            width: 200px;
            white-space: normal;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #1f2937;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin-top: 10px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <h1 class="text-2xl font-bold text-gray-900">Persona Parameter Testing</h1>
                <div class="flex items-center space-x-4">
                    <label class="text-sm font-medium text-gray-700">Layout:</label>
                    <select id="layoutSelector" class="border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="1">1 Column</option>
                        <option value="2" selected>2 Columns</option>
                        <option value="3">3 Columns</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Ad Content Input -->
        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Marketing Content to Test:</label>
            <textarea id="adContent" 
                      class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" 
                      rows="3"
                      placeholder="Enter your marketing message here...">Discover our new eco-friendly surf gear collection. Made from 100% recycled ocean plastics, our boards and wetsuits combine performance with sustainability.</textarea>
            
            <!-- Image Upload Section -->
            <div class="mt-4 border-t pt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Optional: Upload Image for Analysis</label>
                <div class="flex items-center space-x-4">
                    <input type="file" 
                           id="imageUpload" 
                           accept="image/*" 
                           onchange="handleImageUpload(event)"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <button onclick="clearImage()" 
                            id="clearImageBtn" 
                            style="display:none;"
                            class="px-4 py-2 text-sm bg-red-50 text-red-700 rounded-md hover:bg-red-100">
                        Clear Image
                    </button>
                </div>
                <div id="imagePreviewContainer"></div>
            </div>
        </div>

        <!-- Testing Columns Container -->
        <div id="columnsContainer" class="grid grid-cols-2 gap-6">
            <!-- Columns will be dynamically generated here -->
        </div>

        <!-- Generate Button -->
        <div class="mt-6 flex justify-center">
            <button onclick="generateAllResponses()" 
                    class="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all">
                Generate Responses
            </button>
        </div>

        <!-- Results Container -->
        <div id="resultsContainer" class="mt-8 grid gap-6">
            <!-- Results will be displayed here -->
        </div>
    </div>

    <script>
        // Configuration
        const LOHAS_SEGMENTS = ['Leader', 'Leaning', 'Learner', 'Laggard'];
        let currentLayout = 2;
        let columnConfigs = [];
        let uploadedImageData = null;

        // Parameter explanations
        const PARAM_EXPLANATIONS = {
            prefill: "Prefill technique provides Claude with the beginning of its response to guide output format and style",
            temperature: "Controls randomness: 0.0 = deterministic, 1.0 = very creative. Higher values produce more varied responses",
            randomizeTemp: "When enabled, randomly selects a temperature value between min and max for each generation",
            topP: "Nucleus sampling: Only considers tokens with cumulative probability up to P. Lower values = more focused",
            maxTokens: "Maximum length of the response in tokens. Approximately 1 token = 0.75 words",
            systemPromptStyle: "Different approaches to persona description: detailed, minimal, values-focused, or demographic-focused"
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            setupLayout(2);
            document.getElementById('layoutSelector').addEventListener('change', (e) => {
                setupLayout(parseInt(e.target.value));
            });
        });

        function setupLayout(columns) {
            currentLayout = columns;
            columnConfigs = [];
            const container = document.getElementById('columnsContainer');
            container.className = `grid gap-6 ${columns === 1 ? 'grid-cols-1' : columns === 2 ? 'grid-cols-2' : 'grid-cols-3'}`;
            container.innerHTML = '';

            for (let i = 0; i < columns; i++) {
                columnConfigs.push({
                    id: i,
                    usePrefill: true,
                    randomizeTemp: false,
                    tempMin: 0.7,
                    tempMax: 1.0,
                    temperature: 0.7,
                    model: 'claude-opus-4-1-20250805',
                    segment: 'Leader',
                    topP: 0.9,
                    maxTokens: 1000,  // Default to 1000 to prevent streaming
                    systemPromptStyle: 'detailed'
                });
                container.appendChild(createColumnPanel(i));
            }
        }

        function createInfoIcon(paramKey) {
            if (!PARAM_EXPLANATIONS[paramKey]) return '';
            return `
                <span class="info-icon">
                    ?
                    <div class="tooltip">
                        ${PARAM_EXPLANATIONS[paramKey]}
                    </div>
                </span>
            `;
        }

        function createColumnPanel(columnId) {
            const panel = document.createElement('div');
            panel.className = 'bg-white rounded-lg shadow-lg p-6 control-panel';
            panel.innerHTML = `
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Scenario ${columnId + 1}</h3>
                
                <!-- Model Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model:</label>
                    <select id="model-${columnId}" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="claude-opus-4-1-20250805">Claude Opus 4.1</option>
                        <option value="claude-sonnet-4-20250514">Claude Sonnet 4.0</option>
                    </select>
                </div>

                <!-- Segment Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">LOHAS Segment:</label>
                    <select id="segment-${columnId}" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        ${LOHAS_SEGMENTS.map(seg => `<option value="${seg}">${seg}</option>`).join('')}
                    </select>
                </div>

                <!-- Prefill Control -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Use Prefill
                        ${createInfoIcon('prefill')}
                    </label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="prefill-${columnId}" value="true" checked 
                                   class="form-radio text-indigo-600" onchange="updateConfig(${columnId}, 'usePrefill', true)">
                            <span class="ml-2">Yes</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="prefill-${columnId}" value="false" 
                                   class="form-radio text-indigo-600" onchange="updateConfig(${columnId}, 'usePrefill', false)">
                            <span class="ml-2">No</span>
                        </label>
                    </div>
                </div>

                <!-- Temperature Control -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Temperature
                        ${createInfoIcon('temperature')}
                    </label>
                    <div class="space-y-2">
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="tempMode-${columnId}" value="fixed" checked 
                                       class="form-radio text-indigo-600" onchange="toggleTempMode(${columnId}, false)">
                                <span class="ml-2">Fixed</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="tempMode-${columnId}" value="random" 
                                       class="form-radio text-indigo-600" onchange="toggleTempMode(${columnId}, true)">
                                <span class="ml-2">
                                    Randomize
                                    ${createInfoIcon('randomizeTemp')}
                                </span>
                            </label>
                        </div>
                        <div class="flex space-x-2 items-center">
                            <span class="text-xs text-gray-500">Min:</span>
                            <input type="number" id="tempMin-${columnId}" value="0.7" min="0" max="1" step="0.1"
                                   class="w-20 border-gray-300 rounded-md shadow-sm text-sm"
                                   onchange="updateConfig(${columnId}, 'tempMin', parseFloat(this.value))">
                            <span class="text-xs text-gray-500">Max:</span>
                            <input type="number" id="tempMax-${columnId}" value="1.0" min="0" max="1" step="0.1"
                                   class="w-20 border-gray-300 rounded-md shadow-sm text-sm"
                                   onchange="updateConfig(${columnId}, 'tempMax', parseFloat(this.value))">
                        </div>
                        <p class="text-xs text-gray-400 italic">When fixed, uses the min value</p>
                    </div>
                </div>

                <!-- Advanced Parameters -->
                <details class="mb-4">
                    <summary class="cursor-pointer text-sm font-medium text-gray-700 mb-2">Advanced Parameters</summary>
                    <div class="mt-2 space-y-3 pl-4">
                        <div>
                            <label class="text-xs font-medium text-gray-600">
                                Top P (Nucleus Sampling)
                                ${createInfoIcon('topP')}
                            </label>
                            <input type="number" id="topP-${columnId}" value="0.9" min="0" max="1" step="0.05"
                                   class="w-full border-gray-300 rounded-md shadow-sm text-sm"
                                   onchange="updateConfig(${columnId}, 'topP', parseFloat(this.value))">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-600">
                                Max Tokens
                                ${createInfoIcon('maxTokens')}
                            </label>
                            <input type="number" id="maxTokens-${columnId}" value="1000" min="50" max="4000" step="50"
                                   class="w-full border-gray-300 rounded-md shadow-sm text-sm"
                                   onchange="updateConfig(${columnId}, 'maxTokens', parseInt(this.value))">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-600">
                                System Prompt Style
                                ${createInfoIcon('systemPromptStyle')}
                            </label>
                            <select id="promptStyle-${columnId}" 
                                    class="w-full border-gray-300 rounded-md shadow-sm text-sm"
                                    onchange="updateConfig(${columnId}, 'systemPromptStyle', this.value)">
                                <option value="detailed">Detailed</option>
                                <option value="minimal">Minimal</option>
                                <option value="values-focused">Values-focused</option>
                                <option value="demographic-focused">Demographic-focused</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-600">Response Count:</label>
                            <input type="number" id="responseCount-${columnId}" value="3" min="1" max="10"
                                   class="w-full border-gray-300 rounded-md shadow-sm text-sm"
                                   onchange="updateConfig(${columnId}, 'responseCount', parseInt(this.value))">
                        </div>
                    </div>
                </details>
            `;

            // Set up event listeners for inputs
            setTimeout(() => {
                document.getElementById(`model-${columnId}`).addEventListener('change', (e) => {
                    updateConfig(columnId, 'model', e.target.value);
                });
                document.getElementById(`segment-${columnId}`).addEventListener('change', (e) => {
                    updateConfig(columnId, 'segment', e.target.value);
                });
            }, 0);

            return panel;
        }

        function updateConfig(columnId, key, value) {
            columnConfigs[columnId][key] = value;
            
            // Update temperature if needed
            if (key === 'tempMin' && !columnConfigs[columnId].randomizeTemp) {
                columnConfigs[columnId].temperature = value;
            }
        }

        function toggleTempMode(columnId, randomize) {
            columnConfigs[columnId].randomizeTemp = randomize;
            if (!randomize) {
                columnConfigs[columnId].temperature = columnConfigs[columnId].tempMin;
            }
        }

        // Image handling functions
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImageData = e.target.result;
                    displayImagePreview(uploadedImageData);
                    document.getElementById('clearImageBtn').style.display = 'inline-block';
                };
                reader.readAsDataURL(file);
            }
        }

        function displayImagePreview(imageData) {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = `
                <img src="${imageData}" class="image-preview" alt="Uploaded image for analysis">
            `;
        }

        function clearImage() {
            uploadedImageData = null;
            document.getElementById('imageUpload').value = '';
            document.getElementById('imagePreviewContainer').innerHTML = '';
            document.getElementById('clearImageBtn').style.display = 'none';
        }

        async function generateAllResponses() {
            const adContent = document.getElementById('adContent').value;
            if (!adContent.trim()) {
                alert('Please enter marketing content to test');
                return;
            }

            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '<div class="text-center py-8"><div class="text-gray-500">Generating responses...</div></div>';

            const results = [];
            for (let i = 0; i < currentLayout; i++) {
                const config = columnConfigs[i];
                
                // Handle temperature randomization
                if (config.randomizeTemp) {
                    config.temperature = config.tempMin + Math.random() * (config.tempMax - config.tempMin);
                } else {
                    config.temperature = config.tempMin;
                }
                
                try {
                    const result = await generateResponse(adContent, config);
                    results.push(result);
                } catch (error) {
                    results.push({
                        columnId: config.id,
                        config: config,
                        error: error.message
                    });
                }
            }

            displayResults(results);
        }

        async function generateResponse(adContent, config) {
            const payload = {
                adContent: adContent,
                segment: config.segment,
                model: config.model,
                temperature: config.temperature,
                temperatureMin: config.tempMin,
                temperatureMax: config.tempMax,
                randomizeTemperature: config.randomizeTemp,
                topP: config.topP,
                maxTokens: config.maxTokens,
                usePrefill: config.usePrefill,
                systemPromptStyle: config.systemPromptStyle,
                responseCount: config.responseCount || 3,
                datasetId: 'surf-clothing'
            };

            // Add image data if uploaded
            if (uploadedImageData) {
                payload.imageData = uploadedImageData;
            }

            console.log(`Generating response for column ${config.id}:`, payload);

            const response = await fetch('/api/generate-claude-response', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to generate response');
            }

            // Handle the response from the API
            const segmentData = data.segments && data.segments[0] || {};
            
            return {
                columnId: config.id,
                config: config,
                responses: segmentData.responses || [segmentData.response] || [],
                responseTemperatures: segmentData.responseTemperatures || [], // Temperatures for each response
                responsePrefills: segmentData.responsePrefills || [], // Prefills used for each response
                sentiment: segmentData.sentiment,
                purchaseIntent: segmentData.purchaseIntent,
                marketSize: segmentData.marketSize,
                imageAnalysis: segmentData.imageAnalysis,
                metadata: data.metadata
            };
        }

        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            container.className = `mt-8 grid gap-6 ${currentLayout === 1 ? 'grid-cols-1' : currentLayout === 2 ? 'grid-cols-2' : 'grid-cols-3'}`;
            
            container.innerHTML = results.map(result => {
                if (result.error) {
                    return `
                        <div class="bg-red-50 rounded-lg p-6 border border-red-200">
                            <h4 class="font-semibold text-red-800 mb-2">Scenario ${result.columnId + 1} - Error</h4>
                            <p class="text-red-600 text-sm">${result.error}</p>
                        </div>
                    `;
                }

                const sentimentColor = result.sentiment === 'positive' ? 'green' : 
                                      result.sentiment === 'negative' ? 'red' : 'gray';
                const purchaseIntentPercent = Math.round((result.purchaseIntent || 0) * 100);

                return `
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Scenario ${result.columnId + 1} Results</h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><span class="font-medium">Model:</span> ${result.config.model.includes('opus') ? 'Opus 4.1' : 'Sonnet 4.0'}</p>
                                <p><span class="font-medium">Segment:</span> ${result.config.segment} (${result.marketSize})</p>
                                <p><span class="font-medium">Temperature:</span> ${result.config.temperature.toFixed(2)}</p>
                                <p><span class="font-medium">Prefill:</span> ${result.config.usePrefill ? 'Yes' : 'No'}</p>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5 class="font-medium text-gray-700 mb-2">Responses (${result.responses.length}):</h5>
                            <div class="space-y-2 max-h-64 overflow-y-auto">
                                ${result.responses.map((resp, idx) => {
                                    const temp = result.responseTemperatures && result.responseTemperatures[idx] 
                                        ? result.responseTemperatures[idx].toFixed(3) 
                                        : result.config.temperature.toFixed(3);
                                    const prefill = result.responsePrefills && result.responsePrefills[idx]
                                        ? result.responsePrefills[idx]
                                        : '';
                                    return `
                                    <div class="p-3 bg-gray-50 rounded text-sm text-gray-700 border-l-4 border-indigo-400">
                                        <div class="flex justify-between items-start mb-2">
                                            <span class="font-medium text-xs text-gray-500">Response ${idx + 1}</span>
                                            <div class="flex gap-2">
                                                <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded">Temp: ${temp}</span>
                                                ${prefill ? `<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded" title="${prefill.replace(/"/g, '&quot;')}">Prefill: "${prefill.length > 15 ? prefill.substring(0, 15) + '...' : prefill}"</span>` : '<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">No prefill</span>'}
                                            </div>
                                        </div>
                                        <p class="mt-1">${resp}</p>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>

                        ${result.imageAnalysis ? `
                            <div class="mb-4">
                                <h5 class="font-medium text-gray-700 mb-2">Image Analysis:</h5>
                                <p class="text-sm text-gray-600 p-3 bg-blue-50 rounded">${result.imageAnalysis}</p>
                            </div>
                        ` : ''}

                        <div class="flex justify-between items-center pt-4 border-t">
                            <div class="text-sm">
                                <span class="font-medium">Sentiment:</span>
                                <span class="ml-2 px-2 py-1 rounded text-xs font-medium bg-${sentimentColor}-100 text-${sentimentColor}-800">
                                    ${result.sentiment}
                                </span>
                            </div>
                            <div class="text-sm">
                                <span class="font-medium">Purchase Intent:</span>
                                <span class="ml-2 font-bold text-indigo-600">${purchaseIntentPercent}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>